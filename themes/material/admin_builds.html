{% extends "admin.html" %}

{% block main %}
  <div class="form">
    <h2>Root folder</h2>
    <div class="form-field">
      <input class="form-field-control" value="{{config.CONFIG.folder}}" readonly>
    </div>
    <div class="form-field">
      <a class="btn btn--sm" href="{{folder.edit_url}}">Open in Google Drive</a>
      <a class="btn btn--sm" href="{{uri_for('sync')}}">Sync root folder</a>
    </div>
  </div>

  <h2>Sub-folders</h2>
  <table class="table">
    <thead>
      <tr>
        <th>Synced</th>
        <th>Title</th>
        <th>Order</th>
        <th>Action</th>
      </tr>
    </thead>
  {% for folder in folders %}
    <tr>
      <td>{{folder.synced}}</td>
      <td><a href="{{folder.url}}">{{folder.title}}</a></td>
      <td>{{folder.weight}}</td>
      <td>
        <a href="{{folder.edit_url}}">Edit</a>
        | <a href="javascript:startSync('{{folder.sync_url}}')">Sync</a>
      </td>
    </tr>
  {% endfor %}
  </table>

  <h2>Sync results</h2>

  <blockquote class="logger"></blockquote>

  <script src="/_ah/channel/jsapi"></script>
  <script>
    var startSync = function(syncUrl) {
      $.get(syncUrl, null, function(resp) {
        var resp = JSON.parse(resp);
        sync(resp['token']);
      });
    };

    var sync = function(token) {
      var logEl = document.querySelector('blockquote');
      var channel = new goog.appengine.Channel(token);
      socket = channel.open();
      socket.onmessage = function(message) {
        var data = message['data'];
        data = JSON.parse(data);
        if (logEl.textContent) {
          logEl.appendChild(document.createElement('br'));
        }
        logEl.appendChild(document.createTextNode(data['message']));
      };
      return socket;
    };
  </script>
{% endblock %}
