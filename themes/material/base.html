{% macro asset(path) -%}
/_app/{{config.VERSION}}/config/{{path}}
{%- endmacro %}

{% macro render_menu(folder, indent=True, active_folder=None, active_page=None) %}
  {% if indent %}
    <a href="{{folder.url}}" class="{{"active" if (folder == active_folder or folder == active_folder.parent)}}">
      {{folder.title}}
      <i class="material-icons">expand_more</i>
    </a>
  {% endif %}
  {% if indent %}<ul class="{{"active" if (folder == active_folder or folder == active_folder.parent)}}">{% endif %}
    {% for sub_folder in folder.children['folders'] %}
    <li class="{{"active-item" if sub_folder == active_folder}}"><a href="{{sub_folder.url}}">{{sub_folder.title}}</a></li>
    {% endfor %}
    {% for page in folder.children['pages'] %}
    <li class="{{"active-item" if page == active_page}}"><a href="{{page.url}}">{{page.title}}</a></li>
    {% endfor %}
  {% if indent %}</ul>{% endif %}
{% endmacro %}

<!doctype html>
<meta charset="utf-8">
<meta content="IE=Edge" http-equiv="X-UA-Compatible">
<meta content="width=device-width,initial-scale=1.0,user-scalable=no" name="viewport">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<link href="https://fonts.googleapis.com/css?family=RobotoDraft:400,500,700,400italic" rel="stylesheet">
<link rel="stylesheet" href="/_app/{{config.VERSION}}/assets/css/main.css">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
<title>{{config.CONFIG.title}}</title>
<body>
  <div class="layout">
    {% if enable_sidebar is not sameas false %}
    <div class="layout-side">
      <div class="layout-side-top">
        <a href="{{uri_for('home')}}">
          {% if config.CONFIG.logo %}
            <img src="{{asset(config.CONFIG.logo)}}" class="layout-side-top-logo">
          {% else %}
            {{config.CONFIG.title or config.CONFIG.sidebar_title}}
          {% endif %}
        </a>
        <div class="layout-side-top-subtitle">{{config.CONFIG.sidebar_title|safe}}</div>
      </div>
      {% block side %}
        <ul>
          {% for folder in folders %}
            {% if folder.weight != -1 %}{% continue %}{% endif %}
            {{render_menu(folder, indent=False, active_page=page)}}
          {% endfor %}
        </ul>
        <div class="layout-side-bordered">
          <ul>
            {% for each_folder in folders %}
              {% if each_folder.weight == -1 %}{% continue %}{% endif %}
              {% if page %}
                {{render_menu(each_folder, active_folder=page.parent, active_page=page)}}
              {% elif folder %}
                {{render_menu(each_folder, active_folder=folder)}}
              {% else %}
                {{render_menu(each_folder)}}
              {% endif %}
            {% endfor %}
          </ul>
        </div>
        <div class="layout-side-bottom">
          {{config.CONFIG.sidebar|safe}}
        </div>
      {% endblock %}
    </div>
    {% endif %}
    <div class="layout-main">
      <div class="layout-main-header">
        {% if enable_sidebar is sameas false %}
          <div class="contained contained--sm">
        {% endif %}
        <div class="layout-main-header-title">
          {{title}}
        </div>
        <div class="layout-main-header-side">
          {% if me.registered %}
            <a href="{{uri_for('settings')}}">{{me.email}}</a> | <a href="{{urls.sign_out()}}">Sign out</a>
          {% else %}
            <a href="{{urls.sign_in()}}" class="btn btn--sm btn--inverted">Sign in</a>
          {% endif %}
        </div>
        {% if enable_sidebar is sameas false %}
          </div>
        {% endif %}
      </div>
      <div class="layout-main-content">
        {% block main %}
        {% endblock %}
      </div>
    </div>
  </div>
